riot.tag2("virtual-scroll","",'virtual-scroll,[data-is="virtual-scroll"]{ display: block; position: relative; overflow-y: auto; overflow-x: hidden; } virtual-scroll > div,[data-is="virtual-scroll"] > div{ position:absolute; }',"",function(t){this.pool=document.createDocumentFragment(),this.nodeBuffer=[],this.lastRepaintY=0,this.lastScrolled=0,this.itemHeight=0,this.totalRows=function(){return Object.keys(this.items).length}.bind(this),this.height=function(){return this.root.clientHeight}.bind(this),this.screenItemsLen=function(){return Math.ceil(this.height()/this.itemHeight)}.bind(this),this.maxBuffer=function(){return this.screenItemsLen()*this.itemHeight}.bind(this),this.cachedItemsLen=function(){return 3*this.screenItemsLen()}.bind(this),this.generator=`${this.root.nodeName}-item-${this._riot_id}`.toLowerCase(),riot.tag(this.generator,this.root.innerHTML,function(t){for(var e in t)this[e]=t[e]}),this.root.innerHTML="",this.on("mount",()=>{this.compStyles=window.getComputedStyle(this.root),this.rootPadding={top:Number(this.compStyles.paddingTop.replace("px","")),bottom:Number(this.compStyles.paddingBottom.replace("px","")),left:Number(this.compStyles.paddingLeft.replace("px","")),right:Number(this.compStyles.paddingRight.replace("px",""))},this.createScroller(),this.calculateBounds(),this.root.addEventListener("scroll",this.onScroll),"undefined"!=typeof ResizeObserver?(this.ro=new ResizeObserver(t=>{for(let e of t)e.target.handleResize&&e.target.handleResize(e)}),this.root.handleResize=this.redraw,this.ro.observe(this.root)):window.addEventListener("resize",this.redraw),this.update()}),this.on("before-unmount",()=>{riot.unregister(this.generator),clearInterval(this.rmNodeInterval),window.removeEventListener("resize",this.redraw),this.ro?this.ro.disconnect():window.detachEvent("onresize",this.redraw);for(var t in this.root.children)t.tag&&t.tag.unmount();for(var t in this.pool.children)t.tag&&t.tag.unmount()}),this.on("update",t=>{this.processOpts(t||this.opts),this.calculateBounds(),this.renderChunk(0)}),this.on("updated",()=>{this.root.scrollTop=0,this.lastScrolled=Date.now()}),this.locate=function(t,e){return new Promise((i,s)=>{if(this.isNumber(t)){if((t=Number(t))<0||t>=this.totalRows())return void s();(e=e||{}).block=["start","center","end"].includes(e.block)?e.block:"center",e.behavior=["smooth","instant","auto"].includes(e.behavior)?e.behavior:"auto";let o=t*this.itemHeight+this.rootPadding.top;switch(e.block){case"center":o-=(this.root.clientHeight-this.itemHeight)/2;break;case"end":o-=this.root.clientHeight-this.itemHeight}o=Math.max(0,o);let h=`[data-index="${t}"]`,r=this.root.querySelector(h);if(r)i(r);else{let e=function(){this.nodeBuffer[t]&&(r=this.root.querySelector(h),i(r),this.off("scrolled",e))};this.on("scrolled",e)}this.root.scroll(Object.assign(e,{top:o}))}else s()})}.bind(this),this.processOpts=function(t){this.items=t.items||this.items||[],this.item=t.item||this.item||"item",this.key=t.key||this.key||"key",this.index=t.index||this.index||"index",this.itemClass=t.itemclass||this.itemClass||null}.bind(this),this.createScroller=function(t){var e=document.createElement("div");e.style.opacity=0,e.style.position="absolute",e.style.top=0,e.style.left=0,e.style.width="1px",this.root.appendChild(e),this.scroller=e}.bind(this),this.updateScrollerHeight=function(){this.scroller.style.height=this.itemHeight*this.totalRows()+this.rootPadding.top+this.rootPadding.bottom-this.itemBounds.bottom-this.itemBounds.top-20+"px"}.bind(this),this.getOne=function(t){let e;if(this.pool.childElementCount)e=this.pool.firstElementChild,this.pool.removeChild(e),e.tag.update(t);else{e=document.createElement("div");let i=riot.mount(e,this.generator,t)[0];e.tag=i}return this.itemClass&&(e.className=this.itemClass),e.style.width=this.itemWidth+"px",e}.bind(this),this.putOne=function(t){this.pool.appendChild(t)}.bind(this),this.getChildOpts=function(t){let e={},i=Object.keys(this.items)[t];return e[this.index]=t,e[this.key]=i,e[this.item]=this.items[i],Object.assign({parent:this.parent||this},e)}.bind(this),this.onScroll=function(t){let e=((t=t||window.event).target||t.srcElement).scrollTop;if(!this.lastRepaintY||Math.abs(e-this.lastRepaintY)>this.maxBuffer()){var i=parseInt(e/this.itemHeight)-this.screenItemsLen();this.renderChunk(i<0?0:i),this.lastRepaintY=e,this.trigger("scrolled",i)}this.lastScrolled=Date.now(),t.preventDefault&&t.preventDefault()}.bind(this),this.redraw=function(){this.calculateBounds(),this.root.scrollTo(0,this.rendered.firstVisible*this.itemHeight),this.onScroll({target:this.root}),this.renderChunk(this.rendered.first)}.bind(this),this.calculateBounds=function(){for(this.nodeBuffer=[];this.root.childElementCount>1;)this.putOne(this.root.lastElementChild);let t=this.getOne(this.getChildOpts(0));t.style.visibility="hidden",this.root.appendChild(t),this.itemCompStyles=window.getComputedStyle(t),this.itemBounds={top:Number(this.itemCompStyles.marginTop.replace("px","")),bottom:Number(this.itemCompStyles.marginBottom.replace("px","")),left:Number(this.itemCompStyles.marginLeft.replace("px","")),right:Number(this.itemCompStyles.marginRight.replace("px","")),border:Number(this.itemCompStyles.borderWidth.replace("px",""))},this.itemHeight=t.clientHeight+this.itemBounds.top+this.itemBounds.bottom+2*this.itemBounds.border,this.itemWidth=this.root.clientWidth-this.rootPadding.left-this.rootPadding.right-this.scroller.clientWidth+1-this.itemBounds.left-this.itemBounds.right-2*this.itemBounds.border,t.style.visibility="",this.putOne(t),this.updateScrollerHeight()}.bind(this),this.renderChunk=function(t){let e=t+this.cachedItemsLen();e>this.totalRows()&&(e=this.totalRows());let i=document.createDocumentFragment();for(var s=t;s<e;s++)this.nodeBuffer[s]||((h=this.getOne(this.getChildOpts(s))).style.top=s*this.itemHeight+this.rootPadding.top+"px",h.dataset.index=s,this.nodeBuffer[s]=h,i.appendChild(h));for(var o=1;o<this.root.childNodes.length;o++){var h=this.root.childNodes[o];h.dataset.index&&h.dataset.index>=t&&h.dataset.index<e||(this.putOne(h),o--,delete this.nodeBuffer[h.dataset.index])}this.root.appendChild(i),this.rendered={first:t,last:e,firstVisible:Math.round(this.root.scrollTop/this.itemHeight),ratio:this.root.scrollTop/this.root.scrollHeight}}.bind(this),this.isNumber=function(t){return("number"==typeof t||Number(t).toString()===t)&&!isNaN(t)}.bind(this),this.processOpts(this.opts)});